- name: create directory
  file: path=~/war state=directory

- name: open port 8080
  command: netsh firewall add portopening TCP 8080 "Allow port 8080"

- name: copy microsoft redist 
  copy: src=vcredist_x86.exe dest=~/ mode=777

- name: install microsoft redist
  command: ./vcredist_x86.exe /quiet

- name: copy install script
  copy: src=install.sh dest=~/war/install.sh mode=700

- name: copy jce policy
  copy: src=jce_policy-8.zip dest=~/war/jce_policy-8.zip

- name: copy marlin jar
  copy: src=marlin-0.7.3-Unsafe.jar dest=~/war/  mode=700

- name: copy apache
  copy: src=apache-tomcat-8.0.32.exe dest=~/war/  mode=700

- name: copy jre
  copy: src=jre-8u91-windows-i586.exe dest=~/war/  mode=700

- name: copy libjpeg
  copy: src=libjpeg-turbo-1.4.2-vc.exe dest=~/war/  mode=700

- name: copy netcdf
  copy: src=netCDF4.4.0-NC4-32.exe dest=~/war/ mode=700

- name: copy gdal bin
  copy: src=GDAL-suite4.9.zip dest=~/

- name: copy geoserver data directory
  copy: src=geoserverDataDir.zip dest=/cygdrive/c/

- name: unzip data dir
  unarchive: src=/cygdrive/c/geoserverDataDir.zip dest=/cygdrive/c/ mode=0777 copy=no

- name: copy test data - ogr
  unarchive: src=../../test_data/cdfadmin13_1.zip dest=/cygdrive/c/geoserverDataDir/ mode=777

- name: copy test data - netcdf
  unarchive: src=../../test_data/netcdf.zip dest=/cygdrive/c/geoserverDataDir/ mode=777

#only run this once, if re-run will hang script
- name: run the script
  command: ./install.sh chdir=~/war

- name: copy gdal files into tomcat bin
  shell: "unzip -o GDAL-suite4.9.zip -d '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/bin/'"

- name: copy libjpeg-turbo
  shell: "cp /cygdrive/c/libjpeg-turbo/bin/* '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/bin/'"

- name: make bin dir executable
  file: path='/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/bin/' state=directory recurse=yes mode=777

- name: get suite war
  unarchive: src=http://jenkins:Thae9suv@priv-repo.boundlessgeo.com/war-archive/BoundlessSuite-latest-war.zip dest=~/ copy=no

- name: get suite-exts
  get_url: url=http://jenkins:Thae9suv@priv-repo.boundlessgeo.com/war-archive/BoundlessSuite-latest-ext.zip dest=~/ 

- name: unzip suite-exts
  unarchive: src=~/BoundlessSuite-latest-ext.zip dest=~/ copy=no

- name: copy wars to tomcat webapps
  shell: "cp -f ~/BoundlessSuite-latest-war/* '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/webapps/'"

- name: stop tomcat
  command: net stop Tomcat8 
  ignore_errors: yes

- name: explode geoserver war
  shell: "unzip -o '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/webapps/geoserver.war' -d '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/webapps/geoserver'"
  args:
    executable: /bin/bash

- name: copy extensions
  shell: "cp -f -r ~/BoundlessSuite-latest-ext/{{ item }}/* '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/webapps/geoserver/WEB-INF/lib'"
  with_items: 
      - app-schema
      - jdbcconfig
      - cluster
      - geopkg
      - inspire
      - arcsde
      - csw
      - db2
      - gdal
      - mongodb
      - netcdf
      - netcdf-out
      - oracle
      - scripting
      - vectortiles
      - sqlserver
      - wps

- name: copy GDAL jar to webapps
  shell: cp '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/bin/gdal-1.11.2.jar' '/cygdrive/c/Program Files (x86)/Apache Software Foundation/Tomcat 8.0/webapps/geoserver/WEB-INF/lib/'
  args:
    executable: /bin/bash

#add some kind of wait here... if not tomcat hasn't stopped yet this fails
- name: ensure tomcat is stopped
  wait_for: host=0.0.0.0 port=8080 delay=10 state=stopped

- name: start tomcat
  command: net start Tomcat8
