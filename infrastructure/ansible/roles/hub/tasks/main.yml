### get robot tests and test data
- name: install subversion
  yum: name=subversion state=latest

- name: Retrieve test files from git
  subversion: repo=https://github.com/boundlessgeo/SuiteQAAutomation/trunk/robot/ dest=/home/ec2-user/robot export=yes force=yes username=boundlessQA password=QA4Good!

- name: give Robot folder RW permissions
  command: chmod -R 777 robot/

- name: unininstall pil library
  pip: name=pil state=absent

- name: install gcc
  yum: name=gcc state=latest

- name: install Pillow dependencies
  yum: name={{ item }} state=latest
  with_items:
    - libtiff-devel
    - libjpeg-devel
    - libzip-devel
    - freetype-devel
    - lcms2-devel
    - libwebp-devel
    - tcl-devel

- name: install postgres
  yum: name=postgresql-devel state=latest

- name: install RobotFramework
  pip: name=robotframework state=latest

### Install RobotFramework and all packages needed for tests
- name: install RobotFramework and test requirements
  pip: requirements=/home/ec2-user/robot/tests/requirements.txt

### Install docker-py required for Docker module
- name: install docker-py
  pip: name=docker-py

### Install and start Docker
- name: Install Docker
  yum: name=docker state=latest

- name: start docker
  service: name=docker  state=restarted

### pull and start selenium hub image
- name: Selenium Grid Hub container
  docker:
    docker_api_version: 1.21
    name: selenium-hub
    image: selenium/hub:2.52.0
    ports: 4444:4444
    state: reloaded
    pull: missing

- name: install subversion
  yum: name=subversion state=latest

### update ips for robot, server = geoserver(win2012 or ubuntu),remote_url =hub ip
# for gs_ip, pass it in when play is called? 

- name: update remote hub IP
  replace:
    dest: "/home/ec2-user/robot/tests/environment_ansible.robot"
    regexp: '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b:4444'
    replace: '{{ hub_ip }}:4444'

# patch selenium library
- name: Patch Selenium2 Library for Edge
  copy:
    remote_src: True
    src: /home/ec2-user/robot/robot_sel2_patch/_browsermanagement.py
    dest: /usr/local/lib/python2.7/site-packages/Selenium2Library/keywords/_browsermanagement.py

- name: copy test data
  copy: src=test_data dest=/home/ec2-user/

- name: generate ssh key for hub->nginx script
  user: name=ec2-user generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=hub

- name: fetch key
  fetch: src=hub.pub dest=/tmp/hub.pub flat=yes
